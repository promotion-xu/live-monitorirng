<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Streamedian player example</title>
    <style>
      #test_video {
        width: 1080px;
      }

      #video_overlays {
        position: absolute;
        float: left;
        width: 720px;
        height: 480px;
        z-index: 300000;
      }

      .rect {
        border: 2px;
        background-color: green;
        width: 100px;
        height: 100px;
      }

      form {
        margin-bottom: 0.5em;
      }

      .sei {
        position: absolute;
        right: 0;
        top: 0;
      }
      input {
        vertical-align: top;
      }
      select {
        height: 21px;
      }
    </style>
  </head>

  <body>
    <form action="">
      WS HOST:
      <input
        type="text"
        value="ws://10.9.242.48:10080/rtsp-over-ws"
        size="50"
        id="rtsp-ws-source"
      />

      RTSP URL:
      <!-- <input type="text" value="rtsp://admin:admin1234@172.20.101.177:554" size=100 id="rtsp-source"> -->
      <select name="" id="rtsp-source">
        <option value="rtsp://admin:Camerasenset1me@10.9.189.31:554"
          >默认</option
        >
      </select>
      <input type="button" value="play" onClick="onPlay()" id="play" />
    </form>

    <div id="container">
      <div id="video_overlays"></div>
      <video id="test_video" autoplay="false" muted>
        <!--<source src="rtsp://admin:admin1234@172.20.101.177/media/video1/metadata" type="application/x-rtsp">-->
        <!--<source src="rtsp://127.0.0.1:8554/EigI6AcSIwohCh9ydHNwOi8vbG9jYWxob3N0OjQ4ODcvdGVzdDMuZmx2" type="application/x-rtsp">-->
        <!--<source src="rtsp://admin:admin1234@172.20.101.177:554" type="application/x-rtsp">-->
      </video>
    </div>
    <p id="error_msg"></p>
    <div id="operators" style="display: none">
      <button id="reconnect">reconnect</button>
      <button id="cancel">cancel</button>
    </div>
    <div class="sei">
      <div id="sei_data">SEI DATA</div>
      <div id="sei_payload">SEI DATA</div>
    </div>
    <script src="https://cdn.bootcss.com/babel-polyfill/7.4.4/polyfill.min.js"></script>
    <script src="streamedian.js"></script>
    <!-- we use minimal here -->
    <script src="protobuf.min.js"></script>
    <script src="previewinfo_static.js"></script>
    <script>
      "use strict";
      let PreviewInfoSEIID = new Uint8Array([
        0x7d,
        0x4b,
        0x4e,
        0xb8,
        0xcc,
        0xab,
        0x49,
        0x0f,
        0xa8,
        0x18,
        0x76,
        0x92,
        0x9f,
        0xbf,
        0xdd,
        0xd8
      ]).toString();
      let PreviewInfo =
        protobuf.roots["default"].sensetime.viper.video_process.preview_info
          .PreviewInfo;
      console.log("precvoew", PreviewInfoSEIID, protobuf.roots);
      /*
        let PreviewInfo = null;
        protobuf.load("previewinfo.json", function(err, root) {
            if (err) throw err;
    
            PreviewInfo = root.lookupType("sensetime.viper.video_process.PreviewInfo");
    
            console.log(PreviewInfo)
            // Continue at "Obtain a message type" above
        });
        */

      let p;
      // p.setSource(source, "rtsp");
      let player = document.getElementById("test_video");
      let n = document.getElementById("sei_data");
      let n1 = document.getElementById("sei_payload");
      function reconnectHandler(e) {
        return new Promise((resolve, reject) => {
          document.getElementById(
            "error_msg"
          ).innerHTML = `连接错误${e.code}: ${e.msg}`;
          document.getElementById("operators").style.display = "unset";
          document.getElementById("reconnect").addEventListener("click", () => {
            document.getElementById("error_msg").innerHTML = "";
            document.getElementById("operators").style.display = "none";
            resolve();
          });
          document.getElementById("cancel").addEventListener("click", () => {
            document.getElementById("error_msg").innerHTML = "已断开连接";
            document.getElementById("operators").style.display = "none";
            reject();
          });
        });
      }

      function onPlay() {
        document.getElementById("error_msg").innerHTML = "";
        let wsHost = document.getElementById("rtsp-ws-source").value;
        let source = document.getElementById("rtsp-source").value;
        // if (p) {
        //     p.destroy();
        // }
        if (!p)
          p = Streamedian.player("test_video", {
            socket: wsHost,
            reconnectHandler: reconnectHandler
          });
        p.setSource(source, "rtsp");
        return true;
      }

      let tracklets = {};

      function animLoop(element) {
        var running,
          lastFrame = window.performance.now();
        function loop(now) {
          // stop the loop if render returned false
          if (running) {
            requestAnimationFrame(loop);
            let deltaT = now - lastFrame;
            // do not render frame when deltaT is too high
            // if (deltaT < 160) {
            //     running = render(deltaT);
            // }
            // console.log("CUR: ", player.currentTime);
            let videoWidth = player.videoWidth;
            let videoHeight = player.videoHeight;
            // console.log("video: ", videoWidth, videoHeight)

            let ev = p.pullOOBData(player.currentTime + 0.01);
            if (ev && ev.length > 0) {
              let last = ev[ev.length - 1];

              n.innerHTML = JSON.stringify(last);
              let plStr = new TextDecoder("utf-8").decode(last.payload);
              n1.innerHTML =
                "player: " +
                player.currentTime +
                ", scaledPTS: " +
                last.scaledPTS +
                ", payload: '" +
                plStr +
                "'";

              let seiID = last.payload.subarray(0, 16).toString();

              let scale = 0;
              if (videoWidth > 0) {
                scale = 720.0 / videoWidth;
              }
              if (
                scale > 0 &&
                last.seenIDR &&
                PreviewInfo &&
                seiID == PreviewInfoSEIID
              ) {
                let pi = PreviewInfo.decode(last.payload.subarray(16));
                // console.log("decoded = ", JSON.stringify(pi));
                let con = document.getElementById("video_overlays");
                pi.objects.forEach(function(e) {
                  let elem = tracklets[e.trackId];
                  if (!elem) {
                    console.log("new tracklet: ", e.trackId);
                    let div = document.createElement("div");
                    div.style.border = "2px solid blue";
                    div.style.position = "absolute";
                    div.innerHTML = e.objectType + ", " + e.trackId;
                    elem = {
                      div: div,
                      ts: now
                    };
                  }

                  let w = e.bounding.vertices[1].x - e.bounding.vertices[0].x;
                  let h = e.bounding.vertices[1].y - e.bounding.vertices[0].y;
                  let x = e.bounding.vertices[0].x;
                  let y = e.bounding.vertices[0].y;
                  w = w * scale;
                  h = h * scale;
                  x = x * scale;
                  y = y * scale;

                  let div = elem.div;
                  div.style.width = w + "px";
                  div.style.height = h + "px";
                  div.style.left = x + "px";
                  div.style.top = y + "px";
                  elem.ts = now;

                  if (!tracklets[e.trackId]) {
                    tracklets[e.trackId] = elem;
                    con.appendChild(div);
                  }
                });
              }
            }
            Object.keys(tracklets).forEach(function(k) {
              let t = tracklets[k].ts;
              // 200ms
              if (now - t > 1000) {
                console.log("remove tracklet: ", k, now - t);
                tracklets[k].div.remove();
                delete tracklets[k];
              }
            });
            lastFrame = now;
          }
        }
        loop(lastFrame);
      }
      animLoop(n);

      let el = document.getElementById("rtsp-source");

      function createOption(start, end, tpl, pre, match) {
        for (let index = start; index < end; index++) {
          let option = document.createElement("option");
          let value = tpl.replace("$ip", index);
          option.value = value;
          option.text = pre + index;
          if (typeof match !== "undefined") {
            if (index === match) {
              option.selected = true;
            }
          }

          el.appendChild(option);
        }
      }
      createOption(
        1,
        125,
        "rtsp://admin:Camerasenset1me@10.9.189.$ip:554",
        "深圳湾 "
      );
      createOption(
        170,
        180,
        "rtsp://admin:admin1234@172.20.101.$ip:554",
        "海翔 "
      );

      document.getElementById("rtsp-source").onchange = onPlay;
      document.onkeydown = function(e) {
        if (e.key === "ArrowRight") {
          el.selectedOptions[0].nextElementSibling &&
            (el.selectedOptions[0].nextElementSibling.selected = true);
          onPlay();
          e.preventDefault();
        } else if (e.key === "ArrowLeft") {
          el.selectedOptions[0].previousElementSibling &&
            (el.selectedOptions[0].previousElementSibling.selected = true);
          onPlay();
          e.preventDefault();
        }
      };
      onPlay();
    </script>
  </body>
</html>
